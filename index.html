<?php
// Database connection
$conn = mysqli_connect("localhost", "root", "", "excel_data");

// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

// Pagination settings
$records_per_page = 75;
$page = isset($_GET['page']) ? $_GET['page'] : 1;
$offset = ($page - 1) * $records_per_page;

// Add this query to get unique provinces
$provinces_query = "SELECT DISTINCT province FROM ac_data ORDER BY province";
$provinces_result = mysqli_query($conn, $provinces_query);

// Modify the search and where clause section
$search = isset($_GET['search']) ? mysqli_real_escape_string($conn, $_GET['search']) : '';
$selected_province = isset($_GET['province']) ? mysqli_real_escape_string($conn, $_GET['province']) : '';
$where_clause = "";

if (!empty($search) || !empty($selected_province)) {
    $conditions = array();
    
    if (!empty($search)) {
        $conditions[] = "(assessment_center LIKE '%$search%' OR 
            center_manager LIKE '%$search%' OR 
            sector LIKE '%$search%' OR 
            qualification_title LIKE '%$search%' OR 
            accreditation_number LIKE '%$search%')";
    }
    
    if (!empty($selected_province)) {
        $conditions[] = "province = '$selected_province'";
    }
    
    $where_clause = "WHERE " . implode(" AND ", $conditions);
}

// Modify the queries to include search
$query = "SELECT province, assessment_center, center_manager, sector, qualification_title, 
          accreditation_number, date_accredited, valid_until 
          FROM ac_data 
          $where_clause 
          LIMIT $offset, $records_per_page";
$result = mysqli_query($conn, $query);

// Update total records query to include search
$total_records_query = "SELECT COUNT(*) AS total FROM ac_data $where_clause";
$total_records_result = mysqli_query($conn, $total_records_query);
$total_records = mysqli_fetch_assoc($total_records_result)['total'];
$total_pages = ceil($total_records / $records_per_page);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Table</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="header-container">
        <div class="header-top">
            <h1 class="header-title">Assessment Center Data</h1>
        </div>
        <div class="button-container">
            <a href="index.php" class="action-button">Add New Record</a>
            <a href="export.php" class="action-button">Export Data</a>
        </div>
    </div>

    <div class="search-container">
        <input type="text" class="search-input" placeholder="Search..." value="<?php echo $search; ?>" />
        <select class="search-input" name="province" id="province" value="<?php echo $selected_province; ?>">
            <option value="">Select Province</option>
            <?php while ($row = mysqli_fetch_assoc($provinces_result)) { ?>
                <option value="<?php echo $row['province']; ?>" <?php echo $selected_province == $row['province'] ? 'selected' : ''; ?>><?php echo $row['province']; ?></option>
            <?php } ?>
        </select>
        <button class="search-button" type="submit">Search</button>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead class="thead-dark">
                <tr>
                    <th>Province</th>
                    <th>Assessment Center</th>
                    <th>Center Manager</th>
                    <th>Sector</th>
                    <th>Qualification Title</th>
                    <th>Accreditation Number</th>
                    <th>Date Accredited</th>
                    <th>Valid Until</th>
                </tr>
            </thead>
            <tbody>
                <?php while ($row = mysqli_fetch_assoc($result)) { ?>
                    <tr>
                        <td><?php echo $row['province']; ?></td>
                        <td><?php echo $row['assessment_center']; ?></td>
                        <td><?php echo $row['center_manager']; ?></td>
                        <td><?php echo $row['sector']; ?></td>
                        <td><?php echo $row['qualification_title']; ?></td>
                        <td><?php echo $row['accreditation_number']; ?></td>
                        <td><?php echo $row['date_accredited']; ?></td>
                        <td><?php echo $row['valid_until']; ?></td>
                    </tr>
                <?php } ?>
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div class="pagination">
            <?php for ($i = 1; $i <= $total_pages; $i++) { ?>
                <a href="?page=<?php echo $i; ?>" class="page-link"><?php echo $i; ?></a>
            <?php } ?>
        </div>
    </div>

</body>
</html>
